<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Driver Customization | vGPU Wiki</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="256x256" href="/GPU_Virtualization-Wiki/assets/img/favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/GPU_Virtualization-Wiki/assets/css/0.styles.365d8210.css" as="style"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/app.8b6c031d.js" as="script"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/2.b91d4cf5.js" as="script"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/3.ae88b75f.js" as="script"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/10.c5a20f5c.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/11.1dee2f7e.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/12.a52f0745.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/13.c9c55aa6.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/14.d8a86969.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/15.19637355.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/4.a3c22764.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/5.6474fb52.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/6.25cc8daf.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/7.ef3e5745.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/8.28e20eb3.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/9.a5d99119.js">
    <link rel="stylesheet" href="/GPU_Virtualization-Wiki/assets/css/0.styles.365d8210.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GPU_Virtualization-Wiki/" class="home-link router-link-active"><img src="/GPU_Virtualization-Wiki/assets/img/logo-nogaps.png" alt="vGPU Wiki" class="logo"> <span class="site-name can-hide">vGPU Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/GPU_Virtualization-Wiki/overview.html" class="sidebar-link">Project Overview</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Installation Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GPU_Virtualization-Wiki/installation/preparation.html" class="sidebar-link">Preparation</a></li><li><a href="/GPU_Virtualization-Wiki/installation/driver-customization.html" aria-current="page" class="active sidebar-link">Driver Customization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/driver-customization.html#vgpu-kvm-driver" class="sidebar-link">vGPU-KVM Driver</a></li><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/driver-customization.html#merged-driver" class="sidebar-link">Merged Driver</a></li></ul></li><li><a href="/GPU_Virtualization-Wiki/installation/host-setup.html" class="sidebar-link">Host Setup</a></li><li><a href="/GPU_Virtualization-Wiki/installation/license-server.html" class="sidebar-link">License Server</a></li><li><a href="/GPU_Virtualization-Wiki/installation/guest-setup.html" class="sidebar-link">Guest Setup</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference Documentation</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="frontmatter-title"><a href="#frontmatter-title" class="header-anchor">#</a> Driver Customization</h1> <p>For your system, you may use either use the vGPU-KVM driver or a merged driver, which would supply both DRM (graphics output) and vGPU functions to your host system. Follow directions in either of the sections below, depending on your choice.</p> <p>Alternatively, if you have a pre-patched driver package, you may skip this page and instead install that package by running the following as root, selecting the correct filename as necessary:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">bash</span> <span class="token string">'NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm-patched.run'</span> --dkms
</code></pre></div><p>All directions below assume you have downloaded <code>NVIDIA-GRID-Linux-KVM-510.47.03-511.65.zip</code> from NVIDIA's customer portal and have extracted the file into your current working directory. You will additionally need to download <a href="/GPU_Virtualization-Wiki/patches/510.47.03/nvidia-vgpu-vfio.patch">nvidia-vgpu-vfio.patch</a> and <a href="/GPU_Virtualization-Wiki/patches/510.47.03/nv-kernel.patch">nv-kernel.patch</a> into the same folder.</p> <h2 id="vgpu-kvm-driver"><a href="#vgpu-kvm-driver" class="header-anchor">#</a> vGPU-KVM Driver</h2> <p>This is the most simple setup, as the only modifications necessary are a small handful of patches and additional source files to support consumer GPUs and <a href="/GPU_Virtualization-Wiki/tools/vgpu-unlock-rs.html">vgpu_unlock-rs</a>.</p> <h3 id="unpack-files"><a href="#unpack-files" class="header-anchor">#</a> Unpack files</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">bash</span> <span class="token string">'NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm.run'</span> -x --target vgpu-kvm
</code></pre></div><h3 id="apply-patches"><a href="#apply-patches" class="header-anchor">#</a> Apply patches</h3> <p>These will allow compilation against Linux 5.15+ and prevent the driver from locking itself out upon detection of a consumer GPU.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>patch vgpu-kvm/kernel/nvidia-vgpu-vfio/nvidia-vgpu-vfio.c nvidia-vgpu-vfio.patch
patch vgpu-kvm/kernel/nvidia/nv-kernel.o_binary nv-kernel.patch
</code></pre></div><h3 id="add-unlock-hooks"><a href="#add-unlock-hooks" class="header-anchor">#</a> Add unlock hooks</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> clone <span class="token string">'https://github.com/DualCoder/vgpu_unlock.git'</span> vgpu_unlock

<span class="token function">cp</span> -l vgpu_unlock/kern.ld vgpu-kvm/kernel/nvidia/kern.ld
<span class="token function">cp</span> -l vgpu_unlock/vgpu_unlock_hooks.c vgpu-kvm/kernel/nvidia/vgpu_unlock_hooks.c

<span class="token function">sed</span> -i <span class="token string">'$ a ldflags-y += -T $(src)/nvidia/kern.ld'</span> vgpu-kvm/kernel/nvidia/nvidia.Kbuild
<span class="token function">sed</span> -i <span class="token string">'32 a #include &quot;vgpu_unlock_hooks.c&quot;'</span> vgpu-kvm/kernel/nvidia/os-interface.c

<span class="token builtin class-name">echo</span> <span class="token string">'kernel/common/inc/vgpu_unlock_hooks.c 0644 KERNEL_MODULE_SRC INHERIT_PATH_DEPTH:1 MODULE:vgpu'</span> <span class="token operator">&gt;&gt;</span> vgpu-kvm/.manifest
<span class="token builtin class-name">echo</span> <span class="token string">'kernel/nvidia/kern.ld 0644 KERNEL_MODULE_SRC INHERIT_PATH_DEPTH:1 MODULE:resman'</span> <span class="token operator">&gt;&gt;</span> vgpu-kvm/.manifest
</code></pre></div><h3 id="install"><a href="#install" class="header-anchor">#</a> Install</h3> <p>You can either install the driver directly ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code>vgpu-kvm/nvidia-installer --dkms
</code></pre></div><p>... or you can re-pack it for ease of safe-keeping (and/or use with applications such as <a href="https://libvf.io/" target="_blank" rel="noopener noreferrer">libvf.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>):</p> <div class="language-sh extra-class"><pre class="language-sh"><code>vgpu-kvm/makeself.sh --target-os <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span> --target-arch <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span> <span class="token punctuation">\</span>
    <span class="token string">'vgpu-kvm'</span> <span class="token punctuation">\</span>
    <span class="token string">'./NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm-patched.run'</span> <span class="token punctuation">\</span>
    <span class="token string">'NVIDIA Accelerated Graphics Driver for Linux-x86_64 510.47.03 w/ Unlock Hooks'</span> <span class="token punctuation">\</span>
    ./nvidia-installer
<span class="token function">sed</span> -i <span class="token string">'s/targetdir=.*/targetdir=NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm-patched/'</span> NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm-patched.run
</code></pre></div><h2 id="merged-driver"><a href="#merged-driver" class="header-anchor">#</a> Merged Driver</h2> <p>The more complex of the two approaches, building the merged driver will require more work and possibly some judgement/trial-and-error if not working with the exact release the instructions are written against.</p> <p>You will, in addition to the previous set of prerequisites, need to install Meld to proceed.</p> <h3 id="unpack-files-2"><a href="#unpack-files-2" class="header-anchor">#</a> Unpack files</h3> <p>This expands the Grid and vGPU-KVM driver packages, fixes permissions and creates an intitial copy of the Grid driver to use as a base for the merged driver.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">bash</span> <span class="token string">'NVIDIA-Linux-x86_64-510.47.03-grid.run'</span> -x --target grid
<span class="token function">bash</span> <span class="token string">'NVIDIA-Linux-x86_64-510.47.03-vgpu-kvm.run'</span> -x --target vgpu-kvm

<span class="token function">chmod</span> -R u+w <span class="token builtin class-name">.</span>

<span class="token function">cp</span> -lR grid merged
</code></pre></div><h3 id="resolve-differences-in-meld"><a href="#resolve-differences-in-meld" class="header-anchor">#</a> Resolve differences in Meld</h3> <ol><li><p>Open Meld and start a new 3-way directory comparison.</p> <p><img src="/GPU_Virtualization-Wiki/assets/img/1_start-a-new-comparison.a927eccb.png" alt="Start a new comparison"></p></li> <li><p>Ensure you have no filters applied and change the view option to show file status: new</p> <p><img src="/GPU_Virtualization-Wiki/assets/img/2_select-view-options.927eaa9c.png" alt="Select view options"></p></li> <li><p>Under <code>vgpu-kvm</code>, ctrl + click to select all the items listed in green. These are the files present in the vgpu-kvm driver that need to be copied into the merged driver. Then, right click and select &quot;Copy to Right&quot;.</p> <p><img src="/GPU_Virtualization-Wiki/assets/img/3_select-and-copy.c0a8a686.png" alt="Copy new files"></p></li> <li><p>Update your view options to show file status: modified</p></li> <li><p>Take the <code>post-install</code>, <code>pre-uninstall</code>, <code>nvidia-sources.Kbuild</code> and <code>nvidia-bug-report.sh</code> from <code>vgpu-kvm</code> and copy them to <code>merged</code> (as was done in step 5).</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>This does leave out the code which installs <code>nvidia-gridd</code> and <code>nvidia-topologyd</code>, but those appear to be irrelevant on the host.</p> <p>If that is a concern, you should manually resolve the differences within <code>post-install</code> and <code>pre-uninstall</code>.</p></div></li> <li><p>Manually edit <code>merged/conftest.sh</code> to add the line <code>VGX_KVM_BUILD=1</code> just above where the <code>GRID_BUILD</code> variable is assigned.</p> <p><img src="/GPU_Virtualization-Wiki/assets/img/6_edit-conftest-sh.30fdc81a.png" alt="Edit conftest.sh"></p></li> <li><p>Add the lines from <code>vgpu-kvm</code> into <code>merged/.manifest</code></p> <ul><li>append <code>nvidia-vgpu-vfio</code> to line 4 (the list of modules to build)</li> <li>take any lines that appear in under <code>vgpu-kvm/.manifest</code> as blue or green and copy them to <code>merged/.manifest</code> (for blue sections, you can hold ctrl and click the right arrow to get a copy menu)</li></ul> <p><img src="/GPU_Virtualization-Wiki/assets/img/7_edit-manifest.cf311401.png" alt="Edit manifest"></p></li> <li><p>Close Meld, making sure to save changes to the files which were manually edited.</p></li></ol> <h3 id="apply-support-patches"><a href="#apply-support-patches" class="header-anchor">#</a> Apply support patches</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>patch merged/kernel/nvidia-vgpu-vfio/nvidia-vgpu-vfio.c nvidia-vgpu-vfio.patch
patch merged/kernel/nvidia/nv-kernel.o_binary nv-kernel.patch
</code></pre></div><h3 id="add-unlock-hooks-2"><a href="#add-unlock-hooks-2" class="header-anchor">#</a> Add unlock hooks</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> clone <span class="token string">'https://github.com/DualCoder/vgpu_unlock.git'</span> vgpu_unlock

<span class="token function">cp</span> -l vgpu_unlock/kern.ld merged/kernel/nvidia/kern.ld
<span class="token function">cp</span> -l vgpu_unlock/vgpu_unlock_hooks.c merged/kernel/nvidia/vgpu_unlock_hooks.c

<span class="token function">sed</span> -i <span class="token string">'$ a ldflags-y += -T $(src)/nvidia/kern.ld'</span> merged/kernel/nvidia/nvidia.Kbuild
<span class="token function">sed</span> -i <span class="token string">'32 a #include &quot;vgpu_unlock_hooks.c&quot;'</span> merged/kernel/nvidia/os-interface.c

<span class="token builtin class-name">echo</span> <span class="token string">'kernel/common/inc/vgpu_unlock_hooks.c 0644 KERNEL_MODULE_SRC INHERIT_PATH_DEPTH:1 MODULE:vgpu'</span> <span class="token operator">&gt;&gt;</span> merged/.manifest
<span class="token builtin class-name">echo</span> <span class="token string">'kernel/nvidia/kern.ld 0644 KERNEL_MODULE_SRC INHERIT_PATH_DEPTH:1 MODULE:resman'</span> <span class="token operator">&gt;&gt;</span> merged/.manifest
</code></pre></div><h3 id="install-2"><a href="#install-2" class="header-anchor">#</a> Install</h3> <p>As with the vGPU-KVM driver, you can either install directly (as root) or build a resultant <code>.run</code> package.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>merged/nvidia-installer --dkms
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>merged/makeself.sh --target-os <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span> --target-arch <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span> <span class="token punctuation">\</span>
    <span class="token string">'merged'</span> <span class="token punctuation">\</span>
    <span class="token string">'./NVIDIA-Linux-x86_64-510.47.03-grid-vgpu-kvm.run'</span> <span class="token punctuation">\</span>
    <span class="token string">'NVIDIA Accelerated Graphics Driver for Linux-x86_64 510.47.03 (Merged) w/ Unlock Hooks'</span> <span class="token punctuation">\</span>
    ./nvidia-installer
<span class="token function">sed</span> -i <span class="token string">'s/targetdir=.*/targetdir=NVIDIA-Linux-x86_64-510.47.03-grid-vgpu-kvm/'</span> NVIDIA-Linux-x86_64-510.47.03-grid-vgpu-kvm.run
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki/edit/main/installation/driver-customization.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/GPU_Virtualization-Wiki/installation/preparation.html" class="prev">
        Preparation
      </a></span> <span class="next"><a href="/GPU_Virtualization-Wiki/installation/host-setup.html">
        Host Setup
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/GPU_Virtualization-Wiki/assets/js/app.8b6c031d.js" defer></script><script src="/GPU_Virtualization-Wiki/assets/js/2.b91d4cf5.js" defer></script><script src="/GPU_Virtualization-Wiki/assets/js/3.ae88b75f.js" defer></script>
  </body>
</html>
