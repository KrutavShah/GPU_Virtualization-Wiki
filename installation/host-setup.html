<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Host Setup | vGPU Wiki</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" type="image/png" sizes="256x256" href="/GPU_Virtualization-Wiki/assets/img/favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/GPU_Virtualization-Wiki/assets/css/0.styles.365d8210.css" as="style"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/app.1198a88f.js" as="script"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/2.6e9a635c.js" as="script"><link rel="preload" href="/GPU_Virtualization-Wiki/assets/js/11.d25c9a79.js" as="script"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/10.3f24f898.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/12.81ce28b3.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/13.533fce97.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/14.ef33cd57.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/15.c0b58567.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/16.c12a62b9.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/17.cfde7359.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/18.738d5126.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/3.04459b83.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/4.29ba6645.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/5.b0f35a3c.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/6.786d7c4d.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/7.f9e760cd.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/8.5710aafb.js"><link rel="prefetch" href="/GPU_Virtualization-Wiki/assets/js/9.436b12b0.js">
    <link rel="stylesheet" href="/GPU_Virtualization-Wiki/assets/css/0.styles.365d8210.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GPU_Virtualization-Wiki/" class="home-link router-link-active"><img src="/GPU_Virtualization-Wiki/assets/img/logo-nogaps.png" alt="vGPU Wiki" class="logo"> <span class="site-name can-hide">vGPU Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/GPU_Virtualization-Wiki/overview.html" class="sidebar-link">Project Overview</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Installation Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GPU_Virtualization-Wiki/installation/preparation.html" class="sidebar-link">Preparation</a></li><li><a href="/GPU_Virtualization-Wiki/installation/host-setup.html" aria-current="page" class="active sidebar-link">Host Setup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/host-setup.html#install-unlock-libraries" class="sidebar-link">Install Unlock Libraries</a></li><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/host-setup.html#patch-and-install-nvidia-driver" class="sidebar-link">Patch and Install NVIDIA Driver</a></li><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/host-setup.html#configure-system-services" class="sidebar-link">Configure system services</a></li><li class="sidebar-sub-header"><a href="/GPU_Virtualization-Wiki/installation/host-setup.html#optional-install-a-wrapper-for-nvidia-smi" class="sidebar-link">(OPTIONAL) Install a Wrapper for nvidia-smi</a></li></ul></li><li><a href="/GPU_Virtualization-Wiki/installation/license-server.html" class="sidebar-link">License Server</a></li><li><a href="/GPU_Virtualization-Wiki/installation/guest-setup.html" class="sidebar-link">Guest Setup</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference Documentation</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="frontmatter-title"><a href="#frontmatter-title" class="header-anchor">#</a> Host Setup</h1> <p>Exact instructions for setting up a Linux based system for vGPU vary from distribution to distribution. NVIDIA certifies Red Hat Enterprise Linux KVM for use with their vGPU technology, but they also provide a generic installer package, which is what we will be covering here.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Following the directions below will not allow your host to use the graphics card for display output. See <a href="/GPU_Virtualization-Wiki/tools/merged-driver.html">Merged Driver</a> for how to make that work.</p></div> <h2 id="install-unlock-libraries"><a href="#install-unlock-libraries" class="header-anchor">#</a> Install Unlock Libraries</h2> <p>You will need to download both <a href="../tools/vgpu_unlock">vgpu_unlock</a> and <a href="../tools/vgpu_unlock-rs">vgpu_unlock-rs</a>, both of which are available from GitHub:</p> <ul><li><a href="https://github.com/DualCoder/vgpu_unlock" target="_blank" rel="noopener noreferrer">https://github.com/DualCoder/vgpu_unlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/mbilker/vgpu_unlock-rs" target="_blank" rel="noopener noreferrer">https://github.com/mbilker/vgpu_unlock-rs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>You can download the source archives and copy them over manually or you can, as we will do below, install and use the Git CLI to download them directly on the host.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>All commands for the rest of this page need to be executed as root.</p></div> <h3 id="install-dependencies"><a href="#install-dependencies" class="header-anchor">#</a> Install dependencies</h3> <p>You will need the following packages installed:</p> <ul><li>Git</li> <li>DKMS</li> <li>Kernel Headers</li> <li>Rust</li> <li>mdevctl</li></ul> <p>The installation commands vary depending on your choice of distribution.</p> <ul><li>RHEL:</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>dnf <span class="token function">install</span> <span class="token string">&quot;https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm&quot;</span>
dnf update
dnf --enablerepo<span class="token operator">=</span><span class="token string">&quot;epel&quot;</span> <span class="token function">install</span> dkms kernel-devel mdevctl rust rust-cargo <span class="token function">git</span>
</code></pre></div><ul><li>Debian/Ubuntu:</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">apt-get</span> update
<span class="token function">apt-get</span> upgrade
<span class="token function">apt-get</span> <span class="token function">install</span> dkms linux-headers mdevctl rustc cargo <span class="token function">git</span>
</code></pre></div><ul><li>Arch</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>pacman -Su dkms linux-headers mdevctl rust <span class="token function">git</span>
</code></pre></div><h3 id="download-and-build-libraries"><a href="#download-and-build-libraries" class="header-anchor">#</a> Download and build libraries</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> -p /usr/local/src
<span class="token builtin class-name">cd</span> /usr/local/src

<span class="token function">git</span> clone <span class="token string">&quot;https://github.com/DualCoder/vgpu_unlock&quot;</span>
<span class="token function">git</span> clone <span class="token string">&quot;https://github.com/mbilker/vgpu_unlock-rs&quot;</span>

<span class="token builtin class-name">cd</span> <span class="token string">&quot;vgpu_unlock-rs&quot;</span>

cargo build --release

<span class="token function">mkdir</span> -p /etc/vgpu_unlock
<span class="token function">touch</span> /etc/vgpu_unlock/profile_override.toml

<span class="token function">cp</span> <span class="token string">&quot;./target/release/libvgpu_unlock_rs.so&quot;</span> /usr/local/lib
</code></pre></div><h2 id="patch-and-install-nvidia-driver"><a href="#patch-and-install-nvidia-driver" class="header-anchor">#</a> Patch and Install NVIDIA Driver</h2> <p>For the purposes of this section, it is assumed that you will be installing version 460.73.01 of the NVIDIA vGPU driver package. If you are using a different version, know that you will need to specify the correct version in filenames and other commands below.</p> <p>Begin by copying the vGPU driver &quot;.run&quot; file to <code>/tmp</code> on your host computer. From there, extract the package so the source files can be modified:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /tmp
<span class="token function">bash</span> <span class="token string">&quot;./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm.run&quot;</span> -x
<span class="token builtin class-name">cd</span> <span class="token string">&quot;./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm&quot;</span>
</code></pre></div><p>Modify the file <code>./kernel/nvidia/os-interface.c</code> and add the following line after the other lines which begin with <code>#include</code>, near the beginning of the file:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;/usr/local/src/vgpu_unlock/vgpu_unlock_hooks.c&quot;</span></span>
</code></pre></div><p>Append the following line to <code>./kernel/nvidia/nvidia.Kbuild</code>:</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>ldflags-y <span class="token operator">+=</span> -T /usr/local/src/vgpu_unlock/kern.ld
</code></pre></div><p>Install the driver and register with DKMS:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./nvidia-installer --dkms
</code></pre></div><p>Clean up the installation files:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/
<span class="token function">rm</span> -rf <span class="token string">&quot;./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm&quot;</span> <span class="token punctuation">\</span>
   <span class="token string">&quot;./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm.run&quot;</span>
</code></pre></div><h2 id="configure-system-services"><a href="#configure-system-services" class="header-anchor">#</a> Configure system services</h2> <p>In order to have the NVIDIA vGPU system services use the unlock, modifications must be made to their service definitions. Start by creating the directories <code>/usr/lib/systemd/system/nvidia-vgpud.d</code> and <code>/usr/lib/systemd/system/nvidia-vgpu-mgr.d</code>.</p> <p>Next, place a file in each of those folders named <code>vgpu_unlock-rs.conf</code> with the following contents:</p> <div class="language-systemd extra-class"><pre class="language-systemd"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Environment</span><span class="token operator">=</span><span class="token value attr-value">LD_PRELOAD=/usr/local/lib/libvgpu_unlock-rs.so</span>
<span class="token key attr-name">Environment</span><span class="token operator">=</span><span class="token value attr-value">__RM_NO_VERSION_CHECK=1</span>
</code></pre></div><p>After doing that, run the following command to set both services to run on next boot:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>systemctl <span class="token builtin class-name">enable</span> nvidia-vgpud.service nvidia-vgpu-mgr.service
</code></pre></div><p>Before moving onto configuring the license server and/or vGPU devices for guests, reboot your system to ensure the kernel modules get loaded and services are running.</p> <h2 id="optional-install-a-wrapper-for-nvidia-smi"><a href="#optional-install-a-wrapper-for-nvidia-smi" class="header-anchor">#</a> (OPTIONAL) Install a Wrapper for <code>nvidia-smi</code></h2> <p>Doing this will allow the <code>nvidia-smi</code> utility to recognize supported consumer GPUs as supported for running vGPUs. This is necessary to receive valid output from <code>nvidia-smi vgpu</code> and its related sub-commands.</p> <p>Ensure <code>/usr/local/bin</code> is in your PATH environment variable earlier than <code>/usr/bin</code> and create a file <code>/usr/local/bin/nvidia-smi</code> with the following contents:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token shebang important">#!/usr/bin/bash</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">a</span> <span class="token keyword">in</span> <span class="token variable">$*</span>
<span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$a</span> <span class="token keyword">in</span>
    vgpu<span class="token punctuation">)</span>
      <span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_PRELOAD</span><span class="token operator">=</span><span class="token string">&quot;/usr/local/lib/libvgpu_unlock_rs.so&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">exec</span> /usr/lib/nvidia/nvidia-smi.orig <span class="token variable">$@</span>
</code></pre></div><p>Make that script executable:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">chmod</span> +x <span class="token string">&quot;/usr/local/bin/nvidia-smi&quot;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/KrutavShah/GPU_Virtualization-Wiki/edit/main/installation/host-setup.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/GPU_Virtualization-Wiki/installation/preparation.html" class="prev">
        Preparation
      </a></span> <span class="next"><a href="/GPU_Virtualization-Wiki/installation/license-server.html">
        License Server
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/GPU_Virtualization-Wiki/assets/js/app.1198a88f.js" defer></script><script src="/GPU_Virtualization-Wiki/assets/js/2.6e9a635c.js" defer></script><script src="/GPU_Virtualization-Wiki/assets/js/11.d25c9a79.js" defer></script>
  </body>
</html>
