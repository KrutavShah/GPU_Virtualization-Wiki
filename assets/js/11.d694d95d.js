(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{401:function(s,t,e){"use strict";e.r(t);var a=e(54),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"frontmatter-title"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#frontmatter-title"}},[s._v("#")]),s._v(" "+s._s(s.$frontmatter.title))]),s._v(" "),e("p",[s._v("Exact instructions for setting up a Linux based system for vGPU vary from distribution to distribution. NVIDIA certifies Red Hat Enterprise Linux KVM for use with their vGPU technology, but they also provide a generic installer package, which is what we will be covering here.")]),s._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),e("p",[s._v("Following the directions below will not allow your host to use the graphics card for display output. See "),e("RouterLink",{attrs:{to:"/tools/merged-driver.html"}},[s._v("Merged Driver")]),s._v(" for how to make that work.")],1)]),s._v(" "),e("h2",{attrs:{id:"install-unlock-libraries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-unlock-libraries"}},[s._v("#")]),s._v(" Install Unlock Libraries")]),s._v(" "),e("p",[s._v("You will need to download both "),e("a",{attrs:{href:"../tools/vgpu_unlock"}},[s._v("vgpu_unlock")]),s._v(" and "),e("a",{attrs:{href:"../tools/vgpu_unlock-rs"}},[s._v("vgpu_unlock-rs")]),s._v(", both of which are available from GitHub:")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/DualCoder/vgpu_unlock",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/DualCoder/vgpu_unlock"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/mbilker/vgpu_unlock-rs",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/mbilker/vgpu_unlock-rs"),e("OutboundLink")],1)])]),s._v(" "),e("p",[s._v("You can download the source archives and copy them over manually or you can, as we will do below, install and use the Git CLI to download them directly on the host.")]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),e("p",[s._v("All commands for the rest of this page need to be executed as root.")])]),s._v(" "),e("h3",{attrs:{id:"install-dependencies"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-dependencies"}},[s._v("#")]),s._v(" Install dependencies")]),s._v(" "),e("p",[s._v("You will need the following packages installed:")]),s._v(" "),e("ul",[e("li",[s._v("Git")]),s._v(" "),e("li",[s._v("DKMS")]),s._v(" "),e("li",[s._v("Kernel Headers")]),s._v(" "),e("li",[s._v("Rust")]),s._v(" "),e("li",[s._v("mdevctl")])]),s._v(" "),e("p",[s._v("The installation commands vary depending on your choice of distribution.")]),s._v(" "),e("ul",[e("li",[s._v("RHEL:")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("dnf "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm"')]),s._v("\ndnf update\ndnf --enablerepo"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"epel"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dkms kernel-devel mdevctl rust rust-cargo "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n")])])]),e("ul",[e("li",[s._v("Debian/Ubuntu:")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" upgrade\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dkms linux-headers mdevctl rustc cargo "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n")])])]),e("ul",[e("li",[s._v("Arch")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("pacman -Su dkms linux-headers mdevctl rust "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n")])])]),e("h3",{attrs:{id:"download-and-build-libraries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#download-and-build-libraries"}},[s._v("#")]),s._v(" Download and build libraries")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/src\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/src\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://github.com/DualCoder/vgpu_unlock"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://github.com/mbilker/vgpu_unlock-rs"')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vgpu_unlock-rs"')]),s._v("\n\ncargo build --release\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/vgpu_unlock\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" /etc/vgpu_unlock/profile_override.toml\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./target/release/libvgpu_unlock_rs.so"')]),s._v(" /usr/local/lib\n")])])]),e("h2",{attrs:{id:"patch-and-install-nvidia-driver"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#patch-and-install-nvidia-driver"}},[s._v("#")]),s._v(" Patch and Install NVIDIA Driver")]),s._v(" "),e("p",[s._v("For the purposes of this section, it is assumed that you will be installing version 460.73.01 of the NVIDIA vGPU driver package. If you are using a different version, know that you will need to specify the correct version in filenames and other commands below.")]),s._v(" "),e("p",[s._v('Begin by copying the vGPU driver ".run" file to '),e("code",[s._v("/tmp")]),s._v(" on your host computer. From there, extract the package so the source files can be modified:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm.run"')]),s._v(" -x\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm"')]),s._v("\n")])])]),e("p",[s._v("Modify the file "),e("code",[s._v("./kernel/nvidia/os-interface.c")]),s._v(" and add the following line after the other lines which begin with "),e("code",[s._v("#include")]),s._v(", near the beginning of the file:")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/src/vgpu_unlock/vgpu_unlock_hooks.c"')])]),s._v("\n")])])]),e("p",[s._v("Append the following line to "),e("code",[s._v("./kernel/nvidia/nvidia.Kbuild")]),s._v(":")]),s._v(" "),e("div",{staticClass:"language-makefile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-makefile"}},[e("code",[s._v("ldflags-y "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" -T /usr/local/src/vgpu_unlock/kern.ld\n")])])]),e("p",[s._v("Install the driver and register with DKMS:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("./nvidia-installer --dkms\n")])])]),e("p",[s._v("Clean up the installation files:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./NVIDIA-Linux-x86_64-460.73.01-vgpu-kvm.run"')]),s._v("\n")])])]),e("h2",{attrs:{id:"configure-system-services"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configure-system-services"}},[s._v("#")]),s._v(" Configure system services")]),s._v(" "),e("p",[s._v("In order to have the NVIDIA vGPU system services use the unlock, modifications must be made to their service definitions. Start by creating the directories "),e("code",[s._v("/usr/lib/systemd/system/nvidia-vgpud.d")]),s._v(" and "),e("code",[s._v("/usr/lib/systemd/system/nvidia-vgpu-mgr.d")]),s._v(".")]),s._v(" "),e("p",[s._v("Next, place a file in each of those folders named "),e("code",[s._v("vgpu_unlock-rs.conf")]),s._v(" with the following contents:")]),s._v(" "),e("div",{staticClass:"language-systemd extra-class"},[e("pre",{pre:!0,attrs:{class:"language-systemd"}},[e("code",[e("span",{pre:!0,attrs:{class:"token section"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("Service")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Environment")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("LD_PRELOAD=/usr/local/lib/libvgpu_unlock-rs.so")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Environment")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("__RM_NO_VERSION_CHECK=1")]),s._v("\n")])])]),e("p",[s._v("After doing that, run the following command to set both services to run on next boot:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("systemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" nvidia-vgpud.service nvidia-vgpu-mgr.service\n")])])]),e("p",[s._v("Before moving onto configuring the license server and/or vGPU devices for guests, reboot your system to ensure the kernel modules get loaded and services are running.")]),s._v(" "),e("h2",{attrs:{id:"optional-install-a-wrapper-for-nvidia-smi"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#optional-install-a-wrapper-for-nvidia-smi"}},[s._v("#")]),s._v(" (OPTIONAL) Install a Wrapper for "),e("code",[s._v("nvidia-smi")])]),s._v(" "),e("p",[s._v("Doing this will allow the "),e("code",[s._v("nvidia-smi")]),s._v(" utility to recognize supported consumer GPUs as supported for running vGPUs. This is necessary to receive valid output from "),e("code",[s._v("nvidia-smi vgpu")]),s._v(" and its related sub-commands.")]),s._v(" "),e("p",[s._v("Ensure "),e("code",[s._v("/usr/local/bin")]),s._v(" is in your PATH environment variable earlier than "),e("code",[s._v("/usr/bin")]),s._v(" and create a file "),e("code",[s._v("/usr/local/bin/nvidia-smi")]),s._v(" with the following contents:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/usr/bin/bash")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$*")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\n    vgpu"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LD_PRELOAD")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/lib/libvgpu_unlock_rs.so"')]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("esac")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" /usr/bin/nvidia-smi "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$@")]),s._v("\n")])])]),e("p",[s._v("Make that script executable:")]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/bin/nvidia-smi"')]),s._v("\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);